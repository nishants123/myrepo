<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IndianGPT - Chat (Child Page)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin:0; font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #f7f7fa 0%, #e3f2fd 100%); color: #222; transition: background 0.3s, color 0.3s;}
        body.dark { background: linear-gradient(135deg, #181c24 0%, #23283a 100%); color: #e0e0e0; }
        header { background: #0a3c7d; color: #fff; padding: 1.2rem 0 1rem 0; text-align: center; box-shadow: 0 4px 16px rgba(10,60,125,0.08); position: relative;}
        .brand-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 18px;
            margin-bottom: 0.5rem;
        }
        .logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800 0%, #0a3c7d 100%);
            box-shadow: 0 0 18px #ff9800;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #fff;
            animation: logoPulse 2s infinite;
        }
        @keyframes logoPulse {
            0% { box-shadow: 0 0 18px #ff9800; }
            50% { box-shadow: 0 0 32px #ff9800; }
            100% { box-shadow: 0 0 18px #ff9800; }
        }
        .logo img {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            box-shadow: 0 0 12px #fff3e0;
        }
        .app-title {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: 2px;
            background: linear-gradient(90deg,#ff9800 0%,#fff3e0 40%,#0a3c7d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            text-shadow: 0 2px 12px #0a3c7d22;
            font-family: 'Segoe UI', Arial, sans-serif;
            animation: titleFadeIn 1.5s;
        }
        @keyframes titleFadeIn {
            from { opacity: 0; transform: translateY(-20px);}
            to { opacity: 1; transform: translateY(0);}
        }
        nav { margin-top: 0.7rem; }
        nav a { color: #fff; margin: 0 1rem; text-decoration: none; font-weight: 500; font-size: 1.1rem; transition: color 0.2s;}
        nav a:hover { color: #ff9800; }
        .theme-toggle { position: absolute; top: 18px; right: 32px; cursor: pointer; }
        .theme-toggle img { width: 32px; transition: filter 0.3s; }
        body.dark .theme-toggle img { filter: invert(1) brightness(1.5); background: #23283a; border-radius: 50%; }
        .main-layout { display: flex; max-width: 1200px; margin: 2rem auto; gap: 2rem; }
        .sidebar { width: 260px; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px #0a3c7d22; padding: 1.5rem 1rem; height: 600px; overflow-y: auto; position: relative;}
        body.dark .sidebar { background: #23283a; color: #e0e0e0; }
        .sidebar h3 { color: #0a3c7d; font-size: 1.2rem; margin-bottom: 1rem; }
        body.dark .sidebar h3 { color: #ff9800; }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-list li { padding: 0.7rem 0.5rem; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background 0.2s, color 0.2s;}
        .history-list li.active, .history-list li:hover { background: #e3f2fd; color: #0a3c7d; }
        body.dark .history-list li.active, body.dark .history-list li:hover { background: #23283a; color: #ff9800; }
        .sidebar .clear-btn, .sidebar .new-chat-btn { margin-top: 1rem; background: #ff9800; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 1rem;}
        .sidebar .new-chat-btn { margin-right: 0.5rem; }
        .container { flex: 1; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px #0a3c7d22; padding: 2rem; position: relative;}
        body.dark .container { background: #23283a; color: #e0e0e0; }
        .chat-window { height: 400px; overflow-y: auto; background: #f4f6f8; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0; position: relative;}
        body.dark .chat-window { background: #181c24; border-color: #23283a; }
        .message { margin-bottom: 1.2rem; animation: msgFadeIn 0.7s;}
        @keyframes msgFadeIn {
            from { opacity: 0; transform: translateY(20px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .user { text-align: right; }
        .user .msg { background: #e3f2fd; color: #0a3c7d; display: inline-block; padding: 0.7rem 1.2rem; border-radius: 18px 18px 0 18px; box-shadow: 0 2px 8px #0a3c7d22;}
        body.dark .user .msg { background: #23283a; color: #ff9800; }
        .bot .msg { background: #fff3e0; color: #ff9800; display: inline-block; padding: 0.7rem 1.2rem; border-radius: 18px 18px 18px 0; box-shadow: 0 2px 8px #ff980022;}
        body.dark .bot .msg { background: #181c24; color: #e3f2fd; }
        .input-area { display: flex; gap: 1rem; align-items: center; margin-top: 1rem;}
        .input-area input[type="text"], .input-area textarea { flex: 1; padding: 0.8rem; border-radius: 8px; border: 1px solid #bfc8e2; font-size: 1rem; }
        body.dark .input-area input[type="text"], body.dark .input-area textarea { background: #23283a; color: #e0e0e0; border-color: #23283a; }
        .input-area input[type="file"] { border: none; }
        .input-area button { background: #ff9800; color: #fff; border: none; padding: 0.8rem 2rem; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: 600; box-shadow: 0 2px 8px #0a3c7d22;}
        .input-area button:hover { background: #0a3c7d; }
        .input-area .share-btn { background: #0a3c7d; margin-left: 0.5rem; }
        .input-area .share-btn:hover { background: #ff9800; }
        .input-area .mic-btn { background: #fff3e0; color: #ff9800; border: none; padding: 0.8rem; border-radius: 50%; font-size: 1.2rem; cursor: pointer; box-shadow: 0 2px 8px #ff980022;}
        body.dark .input-area .mic-btn { background: #23283a; color: #ff9800; }
        .mic-btn.listening { background: #ff9800; color: #fff; }
        .uploaded-img { max-width: 120px; max-height: 120px; border-radius: 8px; margin-top: 0.5rem; box-shadow: 0 2px 8px #0a3c7d22;}
        .chat-graphic {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 180px;
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }
        .sidebar-graphic {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 120px;
            opacity: 0.12;
            pointer-events: none;
            z-index: 0;
        }
        footer { background: #0a3c7d; color: #fff; text-align: center; padding: 1rem 0; margin-top: 2rem; font-size: 1.1rem;}
        footer img { width:32px;vertical-align:middle; }
        @media (max-width: 1200px) {
            .main-layout { flex-direction: column; gap: 1rem; }
            .sidebar { width: 100%; height: auto; margin-bottom: 1rem;}
        }
        @media (max-width: 900px) {
            .container { padding: 1rem; }
            .brand-box { flex-direction: column; gap: 8px; }
            .app-title { font-size: 2rem; }
            .chat-graphic { display: none; }
            .sidebar-graphic { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand-box">
            <a href="index.html" style="display:flex;align-items:center;gap:18px;text-decoration:none;">
                <span class="logo">
                    <img src="https://cdn-icons-png.flaticon.com/512/3909/3909444.png" alt="IndianGPT Logo">
                </span>
                <span class="app-title">IndianGPT</span>
            </a>
        </div>
        <nav>
            <a href="#chat">Chat</a>
        </nav>
        <span class="theme-toggle" id="themeToggle" title="Toggle Light/Dark">
            <img id="themeIcon" src="https://cdn-icons-png.flaticon.com/512/869/869869.png" alt="Theme Icon">
        </span>
    </header>
    <div class="main-layout">
        <aside class="sidebar">
            <h3>Chat History</h3>
            <input type="text" id="historySearch" placeholder="Search history..." style="width:100%;margin-bottom:1rem;padding:0.5rem;border-radius:6px;border:1px solid #bfc8e2;">
            <ul class="history-list" id="historyList">
                <!-- Chat history items will appear here -->
            </ul>
            <button class="new-chat-btn" id="newChatBtn">Start New Chat</button>
            <button class="clear-btn" id="clearHistory">Clear All History</button>
            <img src="https://cdn-icons-png.flaticon.com/512/3909/3909444.png" class="sidebar-graphic" alt="Sidebar Graphic">
        </aside>
        <div class="container" id="chat">
            <div class="chat-window" id="chatWindow">
                <!-- Messages will appear here -->
                <img src="https://cdn.pixabay.com/photo/2017/01/31/13/14/robot-2027195_1280.png" class="chat-graphic" alt="3D Robot">
            </div>
            <form class="input-area" id="chatForm" enctype="multipart/form-data">
                <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off" required>
                <button type="button" class="mic-btn" id="micBtn" title="Mic"><span id="micIcon">&#127908;</span></button>
                <input type="file" id="fileInput" accept="image/*">
                <button type="submit">Send</button>
                <button type="button" class="share-btn" id="shareBtn">Share Chat</button>
            </form>
        </div>
    </div>
    <footer>
        <img src="https://cdn-icons-png.flaticon.com/512/3909/3909444.png" alt="IndianGPT Logo">
        &copy; 2025 IndianGPT. All rights reserved.
    </footer>
    <script>
        // Chat history management with localStorage
        let chatHistory = [];
        let chatTopics = [];
        let currentChatIndex = null;

        const chatWindow = document.getElementById('chatWindow');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const fileInput = document.getElementById('fileInput');
        const historyList = document.getElementById('historyList');
        const clearHistoryBtn = document.getElementById('clearHistory');
        const shareBtn = document.getElementById('shareBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const micBtn = document.getElementById('micBtn');
        const micIcon = document.getElementById('micIcon');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');

        // Load history from localStorage
        function loadHistoryFromStorage() {
            const storedHistory = localStorage.getItem('indianGPT_chatHistory');
            const storedTopics = localStorage.getItem('indianGPT_chatTopics');
            const storedIndex = localStorage.getItem('indianGPT_currentChatIndex');
            chatHistory = storedHistory ? JSON.parse(storedHistory) : [];
            chatTopics = storedTopics ? JSON.parse(storedTopics) : [];
            currentChatIndex = storedIndex !== null ? Number(storedIndex) : null;
            renderHistoryList();
            if (currentChatIndex !== null && chatHistory[currentChatIndex]) {
                chatWindow.innerHTML = chatHistory[currentChatIndex];
            }
        }

        function saveHistoryToStorage() {
            localStorage.setItem('indianGPT_chatHistory', JSON.stringify(chatHistory));
            localStorage.setItem('indianGPT_chatTopics', JSON.stringify(chatTopics));
            localStorage.setItem('indianGPT_currentChatIndex', currentChatIndex);
        }

        function addMessage(text, sender, imgSrc = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.innerHTML = `<span class="msg">${text}</span>`;
            if (imgSrc) {
                msgDiv.innerHTML += `<br><img src="${imgSrc}" class="uploaded-img" alt="Uploaded Image">`;
            }
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Improved topic extraction using keywords and fallback to first sentence
        function extractTopic(chatHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = chatHtml;
            const msgs = tempDiv.querySelectorAll('.user .msg');
            if (msgs.length > 0) {
                let text = msgs[0].textContent.toLowerCase();
                // Keyword-based topic detection
                if (text.match(/\bproject\b/)) return 'Project';
                if (text.match(/\bloan\b/)) return 'Loan';
                if (text.match(/\bcode\b|\bprogram\b|\bpython\b|\bjava\b/)) return 'Coding';
                if (text.match(/\bdocument\b|\bletter\b|\bessay\b/)) return 'Document';
                if (text.match(/\btranslate\b|\btranslation\b/)) return 'Translation';
                if (text.match(/\bsearch\b|\bnews\b/)) return 'Search';
                if (text.match(/\bhistory\b/)) return 'History';
                if (text.match(/\bai\b|\bchatgpt\b|\bgpt\b/)) return 'AI';
                if (text.match(/\bmath\b|\bscience\b/)) return 'Education';
                if (text.match(/\bimage\b|\bpicture\b|\bphoto\b/)) return 'Image';
                // Fallback: use first sentence or first few words
                let firstSentence = text.split(/[.?!]/)[0];
                if (firstSentence.length > 30) return firstSentence.slice(0, 30) + '...';
                return firstSentence.charAt(0).toUpperCase() + firstSentence.slice(1);
            }
            return 'Chat';
        }

        function saveChatHistory() {
            if (currentChatIndex === null) {
                chatHistory.push(chatWindow.innerHTML);
                chatTopics.push(extractTopic(chatWindow.innerHTML));
                currentChatIndex = chatHistory.length - 1;
            } else {
                chatHistory[currentChatIndex] = chatWindow.innerHTML;
                chatTopics[currentChatIndex] = extractTopic(chatWindow.innerHTML);
            }
            renderHistoryList();
            saveHistoryToStorage();
        }

        // Search history functionality
        const historySearch = document.getElementById('historySearch');
        historySearch.addEventListener('input', function() {
            renderHistoryList(this.value.trim().toLowerCase());
        });

        // Render history with "dot" menu for delete/share/rename
        function renderHistoryList(searchTerm = '') {
            historyList.innerHTML = '';
            chatHistory.forEach((chat, idx) => {
                const topic = chatTopics[idx] ? chatTopics[idx] : `Chat ${idx + 1}`;
                if (!searchTerm || topic.toLowerCase().includes(searchTerm)) {
                    const li = document.createElement('li');
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.style.alignItems = 'center';
                    li.style.position = 'relative';

                    const topicSpan = document.createElement('span');
                    topicSpan.textContent = topic;
                    topicSpan.style.flex = '1';
                    topicSpan.style.cursor = 'pointer';
                    if (idx === currentChatIndex) li.classList.add('active');
                    topicSpan.onclick = () => {
                        currentChatIndex = idx;
                        chatWindow.innerHTML = chatHistory[idx];
                        renderHistoryList(historySearch.value.trim().toLowerCase());
                        saveHistoryToStorage();
                    };

                    // Dot menu button
                    const dotBtn = document.createElement('button');
                    dotBtn.textContent = 'â‹®';
                    dotBtn.title = 'Options';
                    dotBtn.style.background = 'none';
                    dotBtn.style.border = 'none';
                    dotBtn.style.cursor = 'pointer';
                    dotBtn.style.marginLeft = '8px';
                    dotBtn.style.fontSize = '1.2rem';
                    dotBtn.onclick = function(e) {
                        e.stopPropagation();
                        menuDiv.style.display = menuDiv.style.display === 'block' ? 'none' : 'block';
                    };

                    // Menu div for delete/share/rename
                    const menuDiv = document.createElement('div');
                    menuDiv.style.position = 'absolute';
                    menuDiv.style.right = '30px';
                    menuDiv.style.top = '50%';
                    menuDiv.style.transform = 'translateY(-50%)';
                    menuDiv.style.background = '#fff';
                    menuDiv.style.border = '1px solid #bfc8e2';
                    menuDiv.style.borderRadius = '6px';
                    menuDiv.style.boxShadow = '0 2px 8px #0a3c7d22';
                    menuDiv.style.display = 'none';
                    menuDiv.style.zIndex = '10';

                    // Rename option
                    const renameOpt = document.createElement('button');
                    renameOpt.textContent = 'Rename';
                    renameOpt.style.background = 'none';
                    renameOpt.style.border = 'none';
                    renameOpt.style.cursor = 'pointer';
                    renameOpt.style.padding = '0.5rem 1.2rem';
                    renameOpt.onclick = (e) => {
                        e.stopPropagation();
                        menuDiv.style.display = 'none';
                        const newName = prompt('Enter new topic name:', chatTopics[idx] || topic);
                        if (newName && newName.trim()) {
                            chatTopics[idx] = newName.trim();
                            renderHistoryList(historySearch.value.trim().toLowerCase());
                            saveHistoryToStorage();
                        }
                    };

                    // Share option
                    const shareOpt = document.createElement('button');
                    shareOpt.textContent = 'Share';
                    shareOpt.style.background = 'none';
                    shareOpt.style.border = 'none';
                    shareOpt.style.cursor = 'pointer';
                    shareOpt.style.padding = '0.5rem 1.2rem';
                    shareOpt.onclick = (e) => {
                        e.stopPropagation();
                        let chatText = '';
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = chatHistory[idx];
                        tempDiv.querySelectorAll('.msg').forEach(function(msg) {
                            chatText += msg.textContent + '\n';
                        });
                        if (navigator.share) {
                            navigator.share({
                                title: chatTopics[idx] || topic,
                                text: chatText,
                                url: window.location.href
                            }).catch(() => {
                                navigator.clipboard.writeText(chatText);
                                alert('Chat copied to clipboard! You can paste and share it.');
                            });
                        } else {
                            navigator.clipboard.writeText(chatText);
                            alert('Chat copied to clipboard! You can paste and share it on WhatsApp, Email, etc.');
                        }
                        menuDiv.style.display = 'none';
                    };

                    // Delete option
                    const delOpt = document.createElement('button');
                    delOpt.textContent = 'Delete';
                    delOpt.style.background = 'none';
                    delOpt.style.border = 'none';
                    delOpt.style.cursor = 'pointer';
                    delOpt.style.padding = '0.5rem 1.2rem';
                    delOpt.onclick = (e) => {
                        e.stopPropagation();
                        chatHistory.splice(idx, 1);
                        chatTopics.splice(idx, 1);
                        if (currentChatIndex === idx) {
                            chatWindow.innerHTML = '';
                            currentChatIndex = null;
                        } else if (currentChatIndex > idx) {
                            currentChatIndex--;
                        }
                        renderHistoryList(historySearch.value.trim().toLowerCase());
                        saveHistoryToStorage();
                        menuDiv.style.display = 'none';
                    };

                    menuDiv.appendChild(renameOpt);
                    menuDiv.appendChild(shareOpt);
                    menuDiv.appendChild(delOpt);

                    // Hide menu when clicking elsewhere
                    document.addEventListener('click', function(event) {
                        if (!li.contains(event.target)) {
                            menuDiv.style.display = 'none';
                        }
                    });

                    li.appendChild(topicSpan);
                    li.appendChild(dotBtn);
                    li.appendChild(menuDiv);
                    historyList.appendChild(li);
                }
            });
        }

        clearHistoryBtn.onclick = function() {
            chatHistory = [];
            chatTopics = [];
            currentChatIndex = null;
            chatWindow.innerHTML = '';
            renderHistoryList();
            saveHistoryToStorage();
        };

        newChatBtn.onclick = function() {
            chatWindow.innerHTML = '';
            currentChatIndex = null;
            saveHistoryToStorage();
        };

        // Share chat option (show all sharing options)
        shareBtn.onclick = function() {
            let chatText = '';
            document.querySelectorAll('.chat-window .msg').forEach(function(msg) {
                chatText += msg.textContent + '\n';
            });
            if (navigator.share) {
                navigator.share({
                    title: 'IndianGPT Chat',
                    text: chatText,
                    url: window.location.href // include page URL for more options
                }).catch(() => {
                    // fallback if user cancels or no share targets
                    navigator.clipboard.writeText(chatText);
                    alert('Chat copied to clipboard! You can paste and share it.');
                });
            } else {
                // fallback: show copy to clipboard and prompt user to share manually
                navigator.clipboard.writeText(chatText);
                alert('Chat copied to clipboard! You can paste and share it on WhatsApp, Email, etc.');
            }
        };

        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const text = userInput.value.trim();
            let imgSrc = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                imgSrc = URL.createObjectURL(file);
            }
            if (!text && !imgSrc) return;
            addMessage(text || '[Image Uploaded]', 'user', imgSrc);
            userInput.value = '';
            fileInput.value = '';
            setTimeout(() => {
                addMessage('IndianGPT: Thank you for your message! (AI response here)', 'bot');
                saveChatHistory();
            }, 700);
        });

        chatWindow.addEventListener('DOMNodeInserted', saveChatHistory);

        // Mic/Voice input (mic logo)
        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.continuous = false;
            recognition.interimResults = false;

            micBtn.onclick = function() {
                if (micBtn.classList.contains('listening')) {
                    recognition.stop();
                    micBtn.classList.remove('listening');
                    micIcon.textContent = 'ðŸŽ¤';
                } else {
                    recognition.start();
                    micBtn.classList.add('listening');
                    micIcon.textContent = 'ðŸ”´';
                }
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                micBtn.classList.remove('listening');
                micIcon.textContent = 'ðŸŽ¤';
            };

            recognition.onerror = function() {
                micBtn.classList.remove('listening');
                micIcon.textContent = 'ðŸŽ¤';
            };
        } else {
            micBtn.onclick = function() {
                alert('Voice input is not supported in this browser.');
            };
        }

        // Theme toggle
        let darkMode = false;
        themeToggle.onclick = function() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark', darkMode);

            // Change typing box color in dark mode
            const inputBoxes = document.querySelectorAll('.input-area input[type="text"], .input-area textarea');
            inputBoxes.forEach(box => {
                box.style.background = darkMode ? '#fff' : '';
                box.style.color = darkMode ? '#222' : '';
            });
            document.querySelectorAll('.mic-btn').forEach(el => {
                el.style.background = darkMode ? '#fff' : '';
                el.style.color = darkMode ? '#222' : '';
            });

            // Use different icon for dark/light mode for better visibility
            themeIcon.src = darkMode
                ? "https://cdn-icons-png.flaticon.com/512/869/869869.png"
                : "https://cdn-icons-png.flaticon.com/512/869/869869.png";
            themeIcon.style.filter = darkMode ? "invert(1) brightness(1.5)" : "none";
            themeIcon.style.background = darkMode ? "#23283a" : "none";
            themeIcon.style.borderRadius = darkMode ? "50%" : "none";
        };

        // Load history on page load
        window.onload = loadHistoryFromStorage;
    </script>
</body>
</html>